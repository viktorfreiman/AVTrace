digraph G {
    rankdir = LR;
    node [shape = plaintext; fontname = "monospace";];

{% for device_id, device_info in devices.items() %}
    {{ device_id.upper().replace('-', '_') }} [label = <
        <table border="1" cellborder="1" cellspacing="0" cellpadding="4">
        <tr><td bgcolor="#FFD700" colspan="{{ get_max_cols(device_info) }}"><font point-size="14"><b>{{ device_id.upper().replace('-', ' ') }}</b></font></td></tr>
        {%- if device_info.power and device_info.power != 'psu' %}
        <tr><td port="{{ normalize_port_name(device_info.power) }}" colspan="{{ get_max_cols(device_info) }}"><font point-size="10">{{ device_info.power }}</font></td></tr>
        {%- endif %}
        {%- for port_key, port_value in device_info.items() %}
            {%- if port_key.startswith('port-') %}
                {%- if 'x' in port_value %}
                    {%- set count, port_type = port_value.split('x') %}
                    {%- set count = count | int %}
                    {%- set port_type = port_type.strip() %}
                    {%- set cols = 2 %}
                    {%- for i in range(0, count, cols) %}
        <tr>
                        {%- for j in range(cols) %}
                            {%- set port_num = i + j + 1 %}
                            {%- if port_num <= count %}
            <td port="{{ port_type.lower().replace(' ', '').replace('-', '') }}_{{ port_num }}"><font point-size="10">{{ port_num }} {{ port_type.upper() }}</font></td>
                            {%- else %}
            <td></td>
                            {%- endif %}
                        {%- endfor %}
        </tr>
                    {%- endfor %}
                {%- else %}
        <tr><td port="{{ normalize_port_name(port_value) }}" colspan="{{ get_max_cols(device_info) }}"><font point-size="10">{{ port_value }}</font></td></tr>
                {%- endif %}
            {%- endif %}
        {%- endfor %}
        {%- if device_info.out %}
        <tr><td port="{{ normalize_port_name(device_info.out) }}" colspan="{{ get_max_cols(device_info) }}"><font point-size="10">{{ device_info.out }}</font></td></tr>
        {%- endif %}
        </table>
        >;];
{% endfor %}

    // Connections
{% for connection in connections %}
    {{ connection.source.upper().replace('-', '_') }}{% if connection.source_port %}:{{ connection.source_port }}{% endif %} -> {{ connection.target.upper().replace('-', '_') }}{% if connection.target_port %}:{{ connection.target_port }}{% endif %} [label = "{{ connection.label }}"; color = {{ connection.color }}; penwidth = 2; fontname = "monospace";];
{%- endfor %}
}
